name: Deploy Staging

on:
  push:
    branches: [develop]
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: false
        default: "staging"

jobs:
  deploy-backend:
    name: Deploy Backend to Staging
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
      - name: Install dependencies
        run: npm ci
      - name: Build backend
        run: npm run build
      - name: Prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}
        run: npx prisma migrate deploy
      - name: Deploy to staging server
        env:
          SSH_HOST: ${{ secrets.STAGING_SERVER_HOST }}
          SSH_USER: ${{ secrets.STAGING_SERVER_USER }}
          SSH_KEY: ${{ secrets.STAGING_SSH_KEY }}
        run: |
          echo "$SSH_KEY" > key.pem
          chmod 600 key.pem
          ssh -i key.pem -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST "cd /var/www/app && ./deploy.sh"
      - name: Health check
        env:
          STAGING_API_URL: ${{ secrets.STAGING_API_URL || 'https://staging-api.example.com' }}
        run: |
          echo "Checking health at $STAGING_API_URL/health"
          curl -f --retry 3 --retry-delay 5 --retry-connrefused $STAGING_API_URL/health || exit 1

  deploy-mobile:
    name: Deploy Mobile App (Expo Updates)
    runs-on: ubuntu-latest
    needs: deploy-backend
    defaults:
      run:
        working-directory: mobile-app
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18.x
      - name: Install dependencies
        run: npm ci
      - name: Install Expo CLI
        run: npm install -g expo-cli
      - name: Publish to Expo (staging)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: expo publish --release-channel staging
      - name: Notify
        run: echo "Staging deployment complete"
